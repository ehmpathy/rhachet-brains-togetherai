# blueprint: rhachet-brains-togetherai

> implementation plan to convert xai adapter into together-ai adapter

---

## 1. summary

the repo currently contains a fully functional `rhachet-brains-xai` adapter (8 grok models). the wish is to replace all xai references with together-ai equivalents, expose frontier open-source models via together ai's openai-compatible api, and ship as `rhachet-brains-togetherai`.

the conversion is structurally 1:1 — same architecture, same contract, same patterns. the delta is:
- **identity**: xai -> together (package name, repo field, slug prefix, env var, base url)
- **model catalog**: 8 grok models -> 10 together ai frontier open-source models
- **brain specs**: xai rates/grades -> together ai serverless rates/grades

---

## 2. filediff treestruct

```
[~] package.json                                          # name, description, keywords, repo, homepage, bugs
[~] readme.md                                             # full rewrite for together-ai models and rates
[~] src/index.ts                                          # retain (re-exports from contract/sdk)
[~] src/contract/sdk/index.ts                             # rename getBrainAtomsByXAI -> getBrainAtomsByTogetherAI, update slugs
[~] src/contract/sdk/index.unit.test.ts                   # update test cases for new slug list and count
[~] src/domain.operations/atom/BrainAtom.config.ts        # replace XaiBrainAtomSlug, replace CONFIG_BY_ATOM_SLUG entries
[~] src/domain.operations/atom/genBrainAtom.ts            # repo='together', env=TOGETHER_API_KEY, baseURL=api.together.xyz/v1
[~] src/domain.operations/atom/genBrainAtom.integration.test.ts  # update slug, env var check, model name
[~] src/.test/assets/example.briefs/secret-code.brief.md  # retain (test asset, provider-agnostic)
```

**legend:**
- `[+]` create — file to create
- `[~]` update — file to update
- `[-]` delete — file to delete

no files created or deleted. all changes are updates to the same file set.

---

## 3. codepath treestruct

### 3.1 `package.json`

```
[~] name                    "rhachet-brains-xai" -> "rhachet-brains-togetherai"
[~] description             "rhachet brain.atom adapter for xai grok models" -> "rhachet brain.atom adapter for together ai open-source models"
[~] repository              "ehmpathy/rhachet-brains-xai" -> "ehmpathy/rhachet-brains-togetherai"
[~] homepage                update url
[~] bugs                    update url
[~] keywords                ["xai", "grok"] -> ["together", "togetherai", "qwen", "deepseek", "llama", "open-source"]
[~] version                 "0.2.1" -> "0.0.1" (new package, fresh version)
[o] dependencies            retain all (openai sdk, rhachet, iso-price, zod — all reused)
[o] devDependencies         retain all
[o] peerDependencies        retain all
[o] scripts                 retain all
```

### 3.2 `src/domain.operations/atom/BrainAtom.config.ts`

```
[o] import { asIsoPrice, dividePrice } from 'iso-price'
[o] import { BrainSpec } from 'rhachet'
[o] type BrainAtomConfig                                  # retain shape
[~] type XaiBrainAtomSlug -> TogetherBrainAtomSlug        # rename type, replace slug union
[-] 8 xai/grok/* slug entries                             # delete all grok configs
[+] 10 together/* slug entries                            # create all together-ai configs
[~] CONFIG_BY_ATOM_SLUG                                   # replace Record<XaiBrainAtomSlug> -> Record<TogetherBrainAtomSlug>
[~] jsdoc .sources                                        # update source urls to together ai docs
```

**new slug union:**

```ts
type TogetherBrainAtomSlug =
  | 'together/qwen3/coder-next'       // qwen3-coder-next: 74.2% swe, $0.50/$1.20
  | 'together/qwen3/coder-480b'       // qwen3-coder-480b: 69.6% swe, $2.00/$2.00
  | 'together/qwen3/235b'             // qwen3-235b: general, $0.20/$0.60
  | 'together/deepseek/v3.1'          // deepseek-v3.1: $0.60/$1.70
  | 'together/deepseek/r1'            // deepseek-r1: $3.00/$7.00
  | 'together/kimi/k2'                // kimi-k2: $1.00/$3.00
  | 'together/kimi/k2.5'              // kimi-k2.5: 76.8% swe, $0.50/$2.80
  | 'together/llama4/maverick'        // llama-4-maverick: $0.27/$0.85, 1M ctx
  | 'together/llama3.3/70b'           // llama-3.3-70b: $0.10/$0.20
  | 'together/glm/4.7'               // glm-4.7: 73.8% swe, $0.45/$2.00
```

**config entry pattern (per model):**

```ts
'together/qwen3/coder-next': {
  model: 'Qwen/Qwen3-Coder-Next',        // together ai model id
  description: 'qwen3-coder-next - best cost/performance for code (262K)',
  spec: new BrainSpec({
    cost: {
      time: { speed: { tokens: 150, per: { seconds: 1 } }, latency: { seconds: 0.5 } },
      cash: {
        per: 'token',
        cache: { get: asIsoPrice('$0'), set: asIsoPrice('$0') },  // no cache on together ai
        input: dividePrice({ of: '$0.50', by: 1_000_000 }),       // $0.50/1M
        output: dividePrice({ of: '$1.20', by: 1_000_000 }),      // $1.20/1M
      },
    },
    gain: {
      size: { context: { tokens: 262_000 } },
      grades: { swe: 74.2 },
      cutoff: '2025-06-01',
      domain: 'SOFTWARE',
      skills: { tooluse: true },
    },
  }),
},
```

**note on cache:** together ai does not expose cached-token rates like xai does. all cache fields set to `$0`.

**note on speed/latency:** estimates based on together ai serverless tier benchmarks. these are approximate — exact values depend on load.

### 3.3 `src/domain.operations/atom/genBrainAtom.ts`

```
[~] type re-export           XaiBrainAtomSlug -> TogetherBrainAtomSlug
[~] jsdoc                    update .what, .note, .example to reference together-ai
[~] repo                     'xai' -> 'together'
[~] OpenAI baseURL           'https://api.x.ai/v1' -> 'https://api.together.xyz/v1'
[~] env var                  XAI_API_KEY -> TOGETHER_API_KEY
[o] ask() body               retain entire implementation (openai-compatible, same contract)
[o] message build            retain (system prompt, episode exchanges, user prompt)
[o] json_schema format       retain (zod -> json schema, strict mode)
[o] response parse           retain (JSON.parse + zod parse)
[o] metrics calculation      retain (calcBrainOutputCost, BrainOutputMetrics)
[o] continuables             retain (genBrainContinuables, episode/series)
```

the ask() implementation is **identical** — together ai is openai-compatible. only 3 values change: `repo`, `baseURL`, `apiKey env var`.

### 3.4 `src/contract/sdk/index.ts`

```
[~] getBrainAtomsByXAI -> getBrainAtomsByTogetherAI       # rename export function
[~] slug list                                              # replace 8 xai slugs with 10 together slugs
[~] jsdoc                                                  # update .what to reference together-ai
[o] re-export genBrainAtom                                 # retain
```

### 3.5 `src/contract/sdk/index.unit.test.ts`

```
[~] describe label           'rhachet-brains-xai.unit' -> 'rhachet-brains-togetherai.unit'
[~] case1 label              getBrainAtomsByXAI -> getBrainAtomsByTogetherAI
[~] atom count               8 -> 10
[~] slug check               'xai/grok/code-fast-1' -> 'together/qwen3/coder-next'
[~] case2 slug               'xai/grok/code-fast-1' -> 'together/qwen3/coder-next'
[~] repo assertion           'xai' -> 'together'
[o] test structure            retain given/when/then pattern
[o] BrainAtom assertions     retain instanceof checks
```

### 3.6 `src/domain.operations/atom/genBrainAtom.integration.test.ts`

```
[~] env var check            XAI_API_KEY -> TOGETHER_API_KEY
[~] env var error message    update to reference TOGETHER_API_KEY
[~] slug                     'xai/grok/code-fast-1' -> 'together/qwen3/coder-next'
[~] case1 label              update slug reference
[~] repo assertion           'xai' -> 'together'
[~] slug assertion           update expected slug
[o] case2 (ask)              retain all — provider-agnostic tests
[o] case3 (episode)          retain all — provider-agnostic tests
[o] test structure            retain given/when/then + useThen pattern
[o] test assets               retain secret-code.brief.md (provider-agnostic)
```

### 3.7 `readme.md`

```
[-] all xai content
[+] full rewrite:
    [+] title: rhachet-brains-togetherai
    [+] description: rhachet brain.atom adapter for together ai open-source models
    [+] install: npm install rhachet-brains-togetherai
    [+] usage: genBrainAtom({ slug: 'together/qwen3/coder-next' })
    [+] available brains table: 10 models with rates, context, swe-bench, model ids
    [+] environment: TOGETHER_API_KEY
    [+] sources: together ai docs, model pages
```

---

## 4. contracts

### 4.1 sdk exports (public contract)

```ts
// from 'rhachet-brains-togetherai'
export { genBrainAtom } from './domain.operations/atom/genBrainAtom';
export { getBrainAtomsByTogetherAI } from './contract/sdk';
export type { TogetherBrainAtomSlug } from './domain.operations/atom/BrainAtom.config';
export { CONFIG_BY_ATOM_SLUG } from './domain.operations/atom/BrainAtom.config';
```

### 4.2 genBrainAtom contract

```ts
genBrainAtom(input: { slug: TogetherBrainAtomSlug }): BrainAtom
```

- input: type-safe slug from the union (compile-time enforcement)
- output: `BrainAtom` instance with `.ask()`, `.slug`, `.repo`, `.description`, `.spec`

### 4.3 ask contract (retained from xai, via rhachet)

```ts
brain.ask<TOutput>(input: {
  on?: { episode: BrainEpisode };
  plugs?: BrainAtomPlugs;
  role: { briefs?: Artifact<typeof GitFile>[] };
  prompt: string;
  schema: { output: z.Schema<TOutput> };
}): Promise<BrainOutput<TOutput, 'atom'>>
```

- returns: `{ output, metrics, episode, series }`
- metrics: `{ size: { tokens, chars }, cost: { time, cash } }`
- episode: continuation handle for multi-turn

### 4.4 env var contract

```
TOGETHER_API_KEY   required   together ai api key (from https://api.together.xyz/settings/api-keys)
```

---

## 5. domain decomposition

### 5.1 domain.objects

no new domain objects. the adapter reuses:
- `BrainAtom` (from `rhachet`)
- `BrainSpec` (from `rhachet`)
- `BrainOutput` (from `rhachet`)
- `BrainOutputMetrics` (from `rhachet`)
- `BrainEpisode` (from `rhachet`)

### 5.2 domain.operations

**`BrainAtom.config.ts`** — the core data file
- `TogetherBrainAtomSlug` type union (10 slugs)
- `BrainAtomConfig` type (retained)
- `CONFIG_BY_ATOM_SLUG` record (10 entries with full BrainSpec per model)

**`genBrainAtom.ts`** — the factory (3-line delta from xai version)
- creates OpenAI client with together ai base url
- reads `TOGETHER_API_KEY` from env
- sets `repo: 'together'`
- all else retained: message build, api call, parse, metrics, continuables

### 5.3 contract/sdk

**`index.ts`** — the convenience aggregator
- `getBrainAtomsByTogetherAI()` returns array of all 10 atoms
- re-exports `genBrainAtom` for direct factory access

---

## 6. model catalog

| slug | model id (together api) | context | swe-bench | input $/1M | output $/1M | domain |
|------|-------------------------|---------|-----------|------------|-------------|--------|
| `together/qwen3/coder-next` | `Qwen/Qwen3-Coder-Next` | 262K | 74.2% | $0.50 | $1.20 | SOFTWARE |
| `together/qwen3/coder-480b` | `Qwen/Qwen3-Coder` | 262K | 69.6% | $2.00 | $2.00 | SOFTWARE |
| `together/qwen3/235b` | `Qwen/Qwen3-235B-A22B` | 131K | — | $0.20 | $0.60 | ALL |
| `together/deepseek/v3.1` | `deepseek-ai/DeepSeek-V3` | 128K | — | $0.60 | $1.70 | ALL |
| `together/deepseek/r1` | `deepseek-ai/DeepSeek-R1` | 128K | — | $3.00 | $7.00 | ALL |
| `together/kimi/k2` | `moonshotai/Kimi-K2-Instruct` | 128K | — | $1.00 | $3.00 | ALL |
| `together/kimi/k2.5` | `moonshotai/Kimi-K2.5` | 128K | 76.8% | $0.50 | $2.80 | ALL |
| `together/llama4/maverick` | `meta-llama/Llama-4-Maverick-17B-128E-Instruct` | 1M | — | $0.27 | $0.85 | ALL |
| `together/llama3.3/70b` | `meta-llama/Llama-3.3-70B-Instruct-Turbo` | 128K | — | $0.10 | $0.20 | ALL |
| `together/glm/4.7` | `THUDM/GLM-4.7-Chat` | 128K | 73.8% | $0.45 | $2.00 | ALL |

**note:** model ids must be verified against the together ai models page at build time. the ids above are based on research from `3.1.research.access._.v1.i1.md` and may need minor corrections (e.g., exact version suffixes).

**note:** rates are together ai serverless rates. these differ from cheapest-provider rates (see `ref.chutes-and-openrouter.md`).

---

## 7. test coverage plan

### 7.1 unit tests (`index.unit.test.ts`)

| case | test | assertion |
|------|------|-----------|
| case1 | getBrainAtomsByTogetherAI returns array | `.toHaveLength(10)` |
| case1 | returns BrainAtom instances | `instanceof BrainAtom` for each |
| case1 | includes featured slug | `slugs.toContain('together/qwen3/coder-next')` |
| case2 | genBrainAtom factory returns BrainAtom | `instanceof BrainAtom` |
| case2 | has correct slug | `.slug === 'together/qwen3/coder-next'` |
| case2 | has correct repo | `.repo === 'together'` |

### 7.2 integration tests (`genBrainAtom.integration.test.ts`)

| case | test | assertion |
|------|------|-----------|
| case1 | atom creation | repo, slug, description are correct |
| case2/t0 | ask with simple prompt | response contains expected content, tokens > 0, cash costs defined, time defined |
| case2/t1 | ask with briefs | response leverages ZEBRA42 secret from brief |
| case3/t0 | episode creation | episode defined, hash defined, 1 exchange |
| case3/t1 | episode continuation | second ask remembers PAPAYA99, episode has 2 exchanges |

**env requirement:** `TOGETHER_API_KEY` must be set. fail-fast guard at top of file.

**model for tests:** `together/qwen3/coder-next` — cheapest together ai code model, fast enough for integration tests.

### 7.3 acceptance tests

no dedicated acceptance test file exists in the current repo. the integration tests serve as the primary behavioral validation. if acceptance tests are added later, they would cover:
- blackbox import from built package
- genBrainAtom slug type enforcement
- ask contract satisfaction

---

## 8. execution sequence

the conversion should be done in this order to maintain a green build at each step:

1. **update `BrainAtom.config.ts`** — replace type union and config entries
2. **update `genBrainAtom.ts`** — replace repo, baseURL, env var, type references
3. **update `src/contract/sdk/index.ts`** — rename function, update slugs
4. **update `src/index.ts`** — retain (no change needed, re-exports still work)
5. **update unit test** — new function name, count, slugs
6. **update integration test** — new env var, slugs, assertions
7. **update `package.json`** — name, description, keywords, repo urls, version
8. **update `readme.md`** — full rewrite

steps 1-4 are the code changes. steps 5-6 are the test updates. steps 7-8 are the identity/docs updates.

---

## 9. risks and mitigations

| risk | mitigation |
|------|------------|
| together ai model ids may differ from research | verify each model id against `https://api.together.xyz/v1/models` before integration test |
| together ai may not support `json_schema` response format for all models | test each model with structured output; fall back to `json_object` if needed |
| speed/latency estimates are approximate | use conservative estimates; update after real measurements from integration tests |
| no cache rates on together ai | set cache fields to `$0` — accurate representation of current state |
| swe-bench scores may have been updated since research | cite sources in jsdoc; update when new data is available |

---

## 10. sources

- research: `.behavior/v2026_02_13.together-ai/3.1.research.access._.v1.i1.md`
- vision: `.behavior/v2026_02_13.together-ai/1.vision.md`
- blackbox criteria: `.behavior/v2026_02_13.together-ai/2.1.criteria.blackbox.md`
- provider comparison: `.behavior/v2026_02_13.together-ai/.refs/ref.chutes-and-openrouter.md`
- together ai api docs: `https://docs.together.ai/reference/chat-completions-1`
- together ai models: `https://docs.together.ai/docs/serverless-models`
- together ai rates: `https://www.together.ai/pricing`
